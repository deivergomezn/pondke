<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PondkÃ© â€“ CÃ³digos</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    
    <p class="info">
        Tu progreso se guardarÃ¡ <b>solo en este navegador</b> usando almacenamiento local.
        <br>
        No se envÃ­an datos a ningÃºn servidor.
    </p>
    
    <h2>Canjear CÃ³digo</h2>

    <p id="coins" style="font-size:20px; font-weight:bold;">Monedas: 0</p>

    <input id="code" maxlength="6" placeholder="CÃ³digo de 6 dÃ­gitos">
    <button onclick="validateCode()">Enviar</button>

    <h3>Historial</h3>
    <ul id="history"></ul>

    <button id="buyBtn" style="background:#0069d9; display:none;" onclick="goToStore()">
        Ir a la tienda ðŸ›’
    </button>

</div>

<script src="main.js"></script>
<script>
// ==========================
// Obtener usuario actual
// ==========================
let email = localStorage.getItem("pondke_current");
let users = JSON.parse(localStorage.getItem("pondke_users")) || {};
let usedCodesGlobal = JSON.parse(localStorage.getItem("usedCodesGlobal")) || {};

if (!email || !users[email]) {
    window.location.href = "index.html";
}

let user = users[email];

// ==========================
// Actualizar UI inicial
// ==========================
updateUI();

// ==========================
// Validar cÃ³digo
// ==========================
async function validateCode() {
    let code = document.getElementById("code").value.trim();

    if (code.length !== 6) {
        alert("El cÃ³digo debe tener 6 dÃ­gitos.");
        return;
    }

    // Cargar cÃ³digos vÃ¡lidos desde codes.json
    const res = await fetch("codes.json");
    const validCodes = await res.json();

    if (!validCodes.includes(code)) {
        alert("CÃ³digo invÃ¡lido.");
        return;
    }

    // Verificar si el cÃ³digo ya fue usado por cualquier usuario
    if (usedCodesGlobal[code]) {
        alert(`Este cÃ³digo ya fue canjeado por otro usuario: ${usedCodesGlobal[code]}`);
        return;
    }

    // Registrar cÃ³digo
    user.used.push(code);
    user.coins += 10;
    users[email] = user;

    // Registrar globalmente
    usedCodesGlobal[code] = email;

    // Guardar en localStorage
    localStorage.setItem("pondke_users", JSON.stringify(users));
    localStorage.setItem("usedCodesGlobal", JSON.stringify(usedCodesGlobal));

    alert("CÃ³digo vÃ¡lido! +10 monedas");

    document.getElementById("code").value = "";
    updateUI();
}

// ==========================
// Actualizar interfaz
// ==========================
function updateUI() {
    document.getElementById("coins").innerText = "Monedas: " + user.coins;

    let list = "";
    user.used.forEach(c => list += `<li>${c}</li>`);
    document.getElementById("history").innerHTML = list;

    // Mostrar botÃ³n de tienda si tiene 100 monedas o mÃ¡s
    if (user.coins >= 100) {
        document.getElementById("buyBtn").style.display = "block";
    } else {
        document.getElementById("buyBtn").style.display = "none";
    }
}

// ==========================
// Ir a tienda (store.html)
// ==========================
function goToStore() {
    if (user.coins < 100) {
        alert("Necesitas al menos 100 monedas para acceder a la tienda.");
        return;
    }

    // Guardar progreso antes de ir a la tienda
    users[email] = user;
    localStorage.setItem("pondke_users", JSON.stringify(users));

    // Redirigir a store.html
    window.location.href = "store.html";
}
</script>

</body>
</html>
